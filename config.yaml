gateway:
  host: "0.0.0.0"
  port: 8000
  admin_port: 8001
  admin_enabled: true

# Define upstreams (backend service pools)
upstreams:
  - name: "users-upstream"
    algorithm: "round-robin"  # round-robin, least-connections, ip-hash, weighted, random
    targets:
      - host: "localhost"
        port: 8081
        weight: 100
      - host: "localhost"
        port: 8082
        weight: 100
    health_check:
      enabled: true
      type: "http"
      path: "/health"
      interval: 10
      timeout: 5
      healthy_threshold: 2
      unhealthy_threshold: 3
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      success_threshold: 2
      timeout: 30
    retry:
      enabled: true
      max_retries: 3
      retry_on_status: [502, 503, 504]

  - name: "products-upstream"
    algorithm: "least-connections"
    targets:
      - host: "localhost"
        port: 8091
        weight: 100

# Define services and their routes
services:
  - name: "users-service"
    upstream: "users-upstream"
    path: ""
    enabled: true
    routes:
      - name: "users-route"
        paths: ["/api/users", "/api/users/*"]
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
        strip_path: false
        plugins:
          - name: "jwt-auth"
            config:
              secret: "your-secret-key"
              algorithm: "HS256"
          - name: "rate-limiting"
            config:
              minute: 100
              limit_by: "consumer"

  - name: "products-service"
    upstream: "products-upstream"
    path: ""
    enabled: true
    routes:
      - name: "products-route"
        paths: ["/api/products", "/api/products/*"]
        methods: ["GET", "POST", "PUT", "DELETE"]
        strip_path: false
        plugins:
          - name: "jwt-auth"
            config:
              secret: "your-secret-key"
              algorithm: "HS256"

  - name: "health-service"
    upstream: "users-upstream"
    path: "/health"
    enabled: true
    routes:
      - name: "health-route"
        paths: ["/health"]
        methods: ["GET"]
        strip_path: true

# Global plugins (applied to all routes)
plugins:
  - name: "cors"
    config:
      origins: ["*"]
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
      headers: ["*"]
      credentials: false
      max_age: 86400

  - name: "request-size-limiting"
    config:
      allowed_payload_size: 10
      size_unit: "megabytes"

  - name: "logging"
    config:
      include_request: true
      include_response: true
      include_latencies: true
